<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>student_mis_postgre documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avaoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);

               if ($darkModeToggles.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">student_mis_postgre documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >FinalAttendanceService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/final_attendance/final_attendance.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#aggregateAttendance" >aggregateAttendance</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier">Async</span>
                                <a href="#aggregateAttendanceData" >aggregateAttendanceData</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getFinalAttendanceByStudentId" >getFinalAttendanceByStudentId</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getTopAttendeesByClass" >getTopAttendeesByClass</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getTotalAttendanceByClassAndDate" >getTotalAttendanceByClassAndDate</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(finalAttendanceRepository: <a href="../entitys/FinalAttendance.html" target="_self">Repository&lt;FinalAttendance&gt;</a>, attendancelogService: <a href="../injectables/AttendanceLogService.html" target="_self">AttendanceLogService</a>, userService: <a href="../injectables/UserService.html" target="_self">UserService</a>, studentService: <a href="../injectables/StudentService.html" target="_self">StudentService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="18" class="link-to-prism">src/final_attendance/final_attendance.service.ts:18</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>finalAttendanceRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/FinalAttendance.html" target="_self" >Repository&lt;FinalAttendance&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>attendancelogService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AttendanceLogService.html" target="_self" >AttendanceLogService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/UserService.html" target="_self" >UserService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>studentService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/StudentService.html" target="_self" >StudentService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="aggregateAttendance"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>aggregateAttendance</b></span>
                        <a href="#aggregateAttendance"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>aggregateAttendance(username: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="166"
                                    class="link-to-prism">src/final_attendance/final_attendance.service.ts:166</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>username</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="aggregateAttendanceData"></a>
                    <span class="name">
                            <span class="modifier"></span>
                            <span class="modifier">Async</span>
                        <span ><b>aggregateAttendanceData</b></span>
                        <a href="#aggregateAttendanceData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>aggregateAttendanceData()</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@Cron(&#x27;0 0 * * *&#x27;)<br /></code>
                </td>
            </tr>

                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="100"
                                    class="link-to-prism">src/final_attendance/final_attendance.service.ts:100</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFinalAttendanceByStudentId"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getFinalAttendanceByStudentId</b></span>
                        <a href="#getFinalAttendanceByStudentId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getFinalAttendanceByStudentId(studentId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="310"
                                    class="link-to-prism">src/final_attendance/final_attendance.service.ts:310</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>studentId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getTopAttendeesByClass"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getTopAttendeesByClass</b></span>
                        <a href="#getTopAttendeesByClass"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getTopAttendeesByClass()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="208"
                                    class="link-to-prism">src/final_attendance/final_attendance.service.ts:208</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getTotalAttendanceByClassAndDate"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getTotalAttendanceByClassAndDate</b></span>
                        <a href="#getTotalAttendanceByClassAndDate"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getTotalAttendanceByClassAndDate()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="251"
                                    class="link-to-prism">src/final_attendance/final_attendance.service.ts:251</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@nestjs/common&#x27;;
import { InjectRepository } from &#x27;@nestjs/typeorm&#x27;;
import { LessThan, MoreThanOrEqual, Repository } from &#x27;typeorm&#x27;;
import { Cron } from &#x27;@nestjs/schedule&#x27;;
import * as moment from &#x27;moment&#x27;;
import { AttendanceLog } from &#x27;src/attendance/entities/attendance.entity&#x27;;
import { User } from &#x27;src/user/entities/user.entity&#x27;;
import { FinalAttendance } from &#x27;./entities/final_attendance.entity&#x27;;
import { AttendanceEnum } from &#x27;src/common/enums/attendance.enum&#x27;;
import { Role } from &#x27;src/user/types&#x27;;
import { AttendanceLogService } from &#x27;src/attendance/attendance.service&#x27;;
import { UserService } from &#x27;src/user/http/services/user.service&#x27;;
import { Student } from &#x27;src/student/entities/student.entity&#x27;;
import { StudentService } from &#x27;src/student/student.service&#x27;;

@Injectable()
export class FinalAttendanceService {
  constructor(
    @InjectRepository(FinalAttendance)
    private readonly finalAttendanceRepository: Repository&lt;FinalAttendance&gt;,
    private readonly attendancelogService: AttendanceLogService,
    private readonly userService: UserService,
    private readonly studentService: StudentService,

  ) {} 

  @Cron(&#x27;0 0 * * *&#x27;) // Runs at midnight every day
//   async aggregateAttendanceData() {
//     const today &#x3D; moment().startOf(&#x27;day&#x27;);
//     const tomorrow &#x3D; moment(today).add(1, &#x27;day&#x27;);
//     const testdate &#x3D;new Date(&#x27;2024-02-05&#x27;)

//     if(testdate.getDay() !&#x3D;&#x3D; 6){
//     // Retrieve all attendance logs for the current day
//     // const attendanceLogs &#x3D; await this.attendancelogService.findByDate(today.toDate(),);
//     const attendanceLogs &#x3D; await this.attendancelogService.findByDate(testdate);

//     // Process attendance logs and calculate total hours spent
//     for (const log of attendanceLogs) {
//       // Find the user based on the username
//       const user &#x3D; await this.userService.findOneByUsername(log.username)
    
//       if (user) {
//         // const totalHours &#x3D; moment(log.exittime).diff(moment(log.entrytime), &#x27;hours&#x27;, true);
//         const totalHours &#x3D; Math.round(moment(log.exittime).diff(moment(log.entrytime), &#x27;hours&#x27;, true));
//         const attendance &#x3D; totalHours &gt;&#x3D; 5 ? AttendanceEnum.PRESENT : AttendanceEnum.ABSENT;
//         const remark &#x3D; totalHours &lt; 5 ? &#x27;Total hours spent in class less than 5, not present&#x27; : null;


//         let finalAttendance &#x3D; await this.finalAttendanceRepository.createQueryBuilder(&#x27;finalAttendance&#x27;)
//         .leftJoinAndSelect(&#x27;finalAttendance.user&#x27;, &#x27;user&#x27;)
//         .where(&#x27;user.id &#x3D; :userId&#x27;, { userId: user.id })
//         .andWhere(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: testdate })
//         .getOne();
  
    
//         if (!finalAttendance) {
//           finalAttendance &#x3D; this.finalAttendanceRepository.create({
//             user: user,
//             date: testdate,
//           });
//         }
        
//         finalAttendance.attendance &#x3D; attendance;
//         finalAttendance.totalHours &#x3D; totalHours;
//         finalAttendance.remark &#x3D; remark;

//         await this.finalAttendanceRepository.save(finalAttendance);
//       } else {
//         console.error(&#x60;User not found for username: ${log.username}&#x60;);
//       }
//     }
//     const unregisteredStudents &#x3D; await this.userService.findUnregisteredStudents();
//     console.log(&#x27;unregisteredstudents&#x27;)
//     // Add unregistered students to the FinalAttendance table with absent status
//     for (const student of unregisteredStudents) {
    
//       const existingRecord &#x3D; await this.finalAttendanceRepository.createQueryBuilder(&#x27;finalAttendance&#x27;)
//       .leftJoinAndSelect(&#x27;finalAttendance.user&#x27;, &#x27;user&#x27;)
//       .where(&#x27;user.id &#x3D; :userId&#x27;, { userId: student.id })
//       .andWhere(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: testdate })
//       .getOne();
//       console.log(&#x27;existing&#x27;,existingRecord)
    
//       if (!existingRecord) {
//         await this.finalAttendanceRepository.save({
//           user: student,
//           date: testdate,
//           attendance: AttendanceEnum.ABSENT,
//           totalHours: 0,
//           remark: null,
//         });
//       }
//     }
//     } else {
//       console.log(&#x27;The provided date is a Saturday.&#x27;);
//     }
// }
async aggregateAttendanceData() {
  for (let currentDate &#x3D; moment(&#x27;2024-02-01&#x27;); currentDate &lt;&#x3D; moment(&#x27;2024-02-10&#x27;); currentDate.add(1, &#x27;day&#x27;)) {
    const testDate &#x3D; currentDate.toDate();

    if (testDate.getDay() !&#x3D;&#x3D; 6) {
      // Retrieve all attendance logs for the current day
      const attendanceLogs &#x3D; await this.attendancelogService.findByDate(testDate);

      // Process attendance logs and calculate total hours spent
      for (const log of attendanceLogs) {
        // Find the user based on the username
        const student &#x3D; await this.studentService.findOneByUsername(log.username);

        if (student) {
          const totalHours &#x3D; Math.round(moment(log.exittime).diff(moment(log.entrytime), &#x27;hours&#x27;, true));
          const attendance &#x3D; totalHours &gt;&#x3D; 5 ? AttendanceEnum.PRESENT : AttendanceEnum.ABSENT;
          const remark &#x3D; totalHours &lt; 5 ? &#x27;Total hours spent in class less than 5, not present&#x27; : null;

          let finalAttendance &#x3D; await this.finalAttendanceRepository.createQueryBuilder(&#x27;finalAttendance&#x27;)
            .leftJoinAndSelect(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
            .where(&#x27;student.id &#x3D; :studentId&#x27;, { studentId: student.id })
            .andWhere(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: testDate })
            .getOne();

          if (!finalAttendance) {
            finalAttendance &#x3D; this.finalAttendanceRepository.create({
              student: student,
              date: testDate,
            });
          }

          finalAttendance.attendance &#x3D; attendance;
          finalAttendance.totalHours &#x3D; totalHours;
          finalAttendance.remark &#x3D; remark;

          await this.finalAttendanceRepository.save(finalAttendance);
        } else {
          console.error(&#x60;Student not found for username: ${log.username}&#x60;);
        }
      }

      const unregisteredStudents &#x3D; await this.studentService.findAll();

      // Add unregistered students to the FinalAttendance table with absent status
      for (const student of unregisteredStudents) {
        const existingRecord &#x3D; await this.finalAttendanceRepository.createQueryBuilder(&#x27;finalAttendance&#x27;)
          .leftJoinAndSelect(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
          .where(&#x27;student.id &#x3D; :studentId&#x27;, { studentId: student.id })
          .andWhere(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: testDate })
          .getOne();

        if (!existingRecord) {
          await this.finalAttendanceRepository.save({
            student: student,
            date: testDate,
            attendance: AttendanceEnum.ABSENT,
            totalHours: 0,
            remark: null,
          });
        }
      }
    } else {
      console.log(&#x60;Skipping Saturday ${moment(testDate).format(&#x27;YYYY-MM-DD&#x27;)}&#x60;);
    }
  }
}
async aggregateAttendance(username: string) {
  // Retrieve all attendance logs for the given username
  const attendanceLogs &#x3D; await this.attendancelogService.findByUsername(username);
  const student &#x3D; await this.studentService.findOneByUsername(username);
  // Process attendance logs and calculate total hours spent
  for (const log of attendanceLogs) {
    const logDate &#x3D; moment(log.date);
    
    // Check if it&#x27;s Saturday (Day 6 in JavaScript Date.getDay())
    if (logDate.day() &#x3D;&#x3D;&#x3D; 6) {
      console.log(&#x60;Skipping Saturday ${logDate.format(&#x27;YYYY-MM-DD&#x27;)}&#x60;);
      continue; // Skip to the next iteration
    }

    const totalHours &#x3D; Math.round(moment(log.exittime).diff(moment(log.entrytime), &#x27;hours&#x27;, true));
    const attendance &#x3D; totalHours &gt;&#x3D; 5 ? AttendanceEnum.PRESENT : AttendanceEnum.ABSENT;
    const remark &#x3D; totalHours &lt; 5 ? &#x27;Total hours spent in class less than 5, not present&#x27; : null;
  
    let finalAttendance &#x3D; await this.finalAttendanceRepository.createQueryBuilder(&#x27;finalAttendance&#x27;)
      .leftJoinAndSelect(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
      .where(&#x27;student.id &#x3D; :studentId&#x27;, { studentId: student.id })
      .andWhere(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: log.date })
      .getOne();

    if (!finalAttendance) {

      finalAttendance &#x3D; this.finalAttendanceRepository.create({
        student: student,
        date: log.date,
      });
    }

    finalAttendance.attendance &#x3D; attendance;
    finalAttendance.totalHours &#x3D; totalHours;
    finalAttendance.remark &#x3D; remark;

    await this.finalAttendanceRepository.save(finalAttendance);
  }
}



async getTopAttendeesByClass() {
  const topAttendees &#x3D; await this.finalAttendanceRepository
    .createQueryBuilder(&#x27;finalAttendance&#x27;)
    .leftJoin(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
    .leftJoin(&#x27;student.class&#x27;, &#x27;classEntity&#x27;) 
    .select([
      &#x27;classEntity.className as className&#x27;, 
      &#x27;student.id as studentId&#x27;,
      &#x27;student.firstName as firstName&#x27;,
      &#x27;student.lastName as lastName&#x27;,
      &#x27;SUM(CASE WHEN finalAttendance.attendance &#x3D; :present THEN 1 ELSE 0 END) AS presentCount&#x27;,
      &#x27;SUM(CASE WHEN finalAttendance.attendance &#x3D; :absent THEN 1 ELSE 0 END) AS absentCount&#x27;,
    ])
    .where(&#x27;finalAttendance.attendance &#x3D; :present OR finalAttendance.attendance &#x3D; :absent&#x27;, {
      present: &#x27;PRESENT&#x27;,
      absent: &#x27;ABSENT&#x27;,
    })
    .groupBy(&#x27;classEntity.className, student.id, student.firstName, student.lastName&#x27;) // Group by class name
    .orderBy(&#x27;classEntity.className&#x27;, &#x27;ASC&#x27;) // Order by class name ascending
    .addOrderBy(&#x27;presentCount&#x27;, &#x27;DESC&#x27;) // Add additional ordering if needed
    .addOrderBy(&#x27;absentCount&#x27;, &#x27;ASC&#x27;) // Add additional ordering if needed
    .getRawMany();

  // Grouping the results by class name
  const groupedResults &#x3D; {};
  topAttendees.forEach(record &#x3D;&gt; {
    const className &#x3D; record.classname;
    console.log(&#x27;className&#x27;,record)
    if (!groupedResults[className]) {
      groupedResults[className] &#x3D; [];
    }
    groupedResults[className].push({
      studentId: record.studentid,
      firstName: record.firstname,
      lastName: record.lastname,
      presentCount: record.presentcount,
      absentCount: record.absentcount
    });
  });

  return groupedResults;
}

async getTotalAttendanceByClassAndDate() {
  const dates &#x3D; await this.finalAttendanceRepository
    .createQueryBuilder(&#x27;finalAttendance&#x27;)
    .select(&#x27;DISTINCT finalAttendance.date&#x27;, &#x27;date&#x27;)
    .orderBy(&#x27;finalAttendance.date&#x27;, &#x27;ASC&#x27;)
    .getRawMany();

  const totalAttendance &#x3D; [];

  for (const dateRecord of dates) {
    const date &#x3D; dateRecord.date;

    // Count total attendees and absentees for the current date
    const totalAttendanceByDate &#x3D; await this.finalAttendanceRepository
      .createQueryBuilder(&#x27;finalAttendance&#x27;)
      .select([
        &#x27;finalAttendance.date AS &quot;date&quot;&#x27;,
        &#x27;COUNT(CASE WHEN finalAttendance.attendance &#x3D; :present THEN 1 END) AS &quot;totalAttendees&quot;&#x27;,
        &#x27;COUNT(CASE WHEN finalAttendance.attendance &#x3D; :absent THEN 1 END) AS &quot;totalAbsentees&quot;&#x27;,
      ])
      .where(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: date })
      .groupBy(&#x27;finalAttendance.date&#x27;)
      .setParameters({ present: &#x27;PRESENT&#x27;, absent: &#x27;ABSENT&#x27;, date: date })
      .getRawOne();

    // Calculate total attendees and absentees for each class on the current date
    const attendanceByDateAndClass &#x3D; await this.finalAttendanceRepository
      .createQueryBuilder(&#x27;finalAttendance&#x27;)
      .leftJoin(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
      .leftJoin(&#x27;student.class&#x27;, &#x27;classEntity&#x27;)
      .select([
        &#x27;classEntity.className AS &quot;className&quot;&#x27;,
        &#x27;COUNT(CASE WHEN finalAttendance.attendance &#x3D; :present THEN 1 END) AS &quot;presentCount&quot;&#x27;,
        &#x27;COUNT(CASE WHEN finalAttendance.attendance &#x3D; :absent THEN 1 END) AS &quot;absentCount&quot;&#x27;,
      ])
      .where(&#x27;finalAttendance.date &#x3D; :date&#x27;, { date: date })
      .groupBy(&#x27;classEntity.className&#x27;)
      .orderBy(&#x27;classEntity.className&#x27;, &#x27;ASC&#x27;)
      .setParameters({ present: &#x27;PRESENT&#x27;, absent: &#x27;ABSENT&#x27;, date: date })
      .getRawMany();

    totalAttendance.push({
      date: new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().substring(0, 10),
      totalAttendees: totalAttendanceByDate.totalAttendees || 0,
      totalAbsentees: totalAttendanceByDate.totalAbsentees || 0,
      attendanceByClass: attendanceByDateAndClass.reduce((acc, curr) &#x3D;&gt; {
        const className &#x3D; curr.className;
        acc[className] &#x3D; {
          presentCount: parseInt(curr.presentCount),
          absentCount: parseInt(curr.absentCount),
        };
        return acc;
      }, {}),
    });
  }

  return totalAttendance;
}

async getFinalAttendanceByStudentId(studentId: string) {
  return this.finalAttendanceRepository
    .createQueryBuilder(&#x27;finalAttendance&#x27;)
    .leftJoinAndSelect(&#x27;finalAttendance.student&#x27;, &#x27;student&#x27;)
    .where(&#x27;student.id &#x3D; :studentId&#x27;, { studentId })
    .orderBy(&#x27;finalAttendance.date&#x27;, &#x27;DESC&#x27;) // Sorting by date in descending order
    .getMany();
}


}




</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'FinalAttendanceService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
